name: Trivy CI
permissions: {}
on:
    pull_request:
        types:
            - opened
            - synchronize
    push:
        branches:
            - "**"

jobs:
    eslint:
        name: ðŸ”ï¸ Check license of packages with Trivy
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - uses: actions/checkout@v6

            - name: Use Node.js
              run: sudo snap install node --channel=24/stable --classic

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Install dependencies
              run: pnpm install

            - name: Run Trivy License Scan
              uses: aquasecurity/trivy-action@master
              with:
                scan-type: 'fs'
                scanners: 'license'
                format: 'json'
                output: 'trivy-result.json'
                version: latest
            
            - name: Log trivy-result.json
              run: cat trivy-result.json

            - name: Setup OPA
              uses: open-policy-agent/setup-opa@v2
              with:
                version: latest

            - name: Evaluate Policy
              run: |
                opa eval -i trivy-result.json -d .github/license.rego "data.user.license_check.deny" --format json > opa-result.json
                cat opa-result.json
                jq -e '.result[0].expressions[0].value | length == 0' opa-result.json > /dev/null
